# Chrome Extension ìžë™ ë°°í¬ ì›Œí¬í”Œë¡œìš°
#
# ì´ ì›Œí¬í”Œë¡œìš°ëŠ” apps/extension ë˜ëŠ” packages/shared ë””ë ‰í† ë¦¬ì— ë³€ê²½ì´ ìžˆì„ ë•Œ
# Chrome Web Storeì— í™•ìž¥ í”„ë¡œê·¸ëž¨ì„ ìžë™ìœ¼ë¡œ ë°°í¬í•©ë‹ˆë‹¤.
#
# í•„ìš”í•œ GitHub Secrets:
# - CHROME_EXTENSION_ID: Chrome Web Storeì˜ í™•ìž¥ í”„ë¡œê·¸ëž¨ ID (ì²« ì—…ë¡œë“œ í›„ ìžë™ ìƒì„±)
# - CHROME_CLIENT_ID: Google Cloud Consoleì—ì„œ ìƒì„±í•œ OAuth 2.0 í´ë¼ì´ì–¸íŠ¸ ID
# - CHROME_CLIENT_SECRET: OAuth 2.0 í´ë¼ì´ì–¸íŠ¸ ì‹œí¬ë¦¿
# - CHROME_REFRESH_TOKEN: chrome-webstore-upload-clië¡œ ìƒì„±í•œ ë¦¬í”„ë ˆì‹œ í† í°
#
# Secrets ì„¤ì • ë°©ë²•:
# 1. Google Cloud Console (https://console.cloud.google.com)ì—ì„œ í”„ë¡œì íŠ¸ ìƒì„±
# 2. Chrome Web Store API í™œì„±í™”
# 3. OAuth 2.0 í´ë¼ì´ì–¸íŠ¸ ID ìƒì„± (ë°ìŠ¤í¬í†± ì•± ìœ í˜•)
# 4. chrome-webstore-upload-clië¥¼ ì‚¬ìš©í•˜ì—¬ ë¦¬í”„ë ˆì‹œ í† í° íšë“:
#    npx chrome-webstore-upload-cli init
# 5. GitHub ì €ìž¥ì†Œ Settings > Secrets and variables > Actionsì— ì‹œí¬ë¦¿ ì¶”ê°€

name: Deploy Chrome Extension

on:
  push:
    branches: ['main']
    paths:
      - 'apps/extension/**'
      - 'packages/shared/**'
      - 'pnpm-workspace.yaml'
      - 'pnpm-lock.yaml'
  workflow_dispatch:
    inputs:
      publish:
        description: 'Publish to Chrome Web Store after upload'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: read

concurrency:
  group: 'chrome-extension'
  cancel-in-progress: true

env:
  EXTENSION_DIR: apps/extension

jobs:
  build:
    name: Build Extension
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint code
        run: pnpm run lint
        working-directory: ${{ env.EXTENSION_DIR }}

      - name: Build extension
        run: pnpm run build
        working-directory: ${{ env.EXTENSION_DIR }}

      - name: Get version from manifest
        id: version
        run: |
          VERSION=$(jq -r '.version' ${{ env.EXTENSION_DIR }}/dist/manifest.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Extension version: $VERSION"

      - name: Verify build output
        run: |
          if [ ! -d "${{ env.EXTENSION_DIR }}/dist" ]; then
            echo "âŒ Error: dist directory not found"
            exit 1
          fi
          if [ ! -f "${{ env.EXTENSION_DIR }}/dist/manifest.json" ]; then
            echo "âŒ Error: manifest.json not found"
            exit 1
          fi
          if [ ! -f "${{ env.EXTENSION_DIR }}/dist/service-worker-loader.js" ]; then
            echo "âŒ Error: service-worker-loader.js not found"
            exit 1
          fi
          echo "âœ… Build output verified"
          echo ""
          echo "ðŸ“ Build contents:"
          ls -la ${{ env.EXTENSION_DIR }}/dist/

      - name: Create ZIP package
        run: |
          cd ${{ env.EXTENSION_DIR }}/dist
          zip -r ../extension.zip ./*
          echo "ðŸ“¦ Created extension.zip"
          ls -la ../extension.zip

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: chrome-extension-${{ steps.version.outputs.version }}
          path: ${{ env.EXTENSION_DIR }}/extension.zip
          retention-days: 30

  deploy:
    name: Deploy to Chrome Web Store
    needs: build
    runs-on: ubuntu-latest
    # ì‹œí¬ë¦¿ì´ ì„¤ì •ë˜ì–´ ìžˆì„ ë•Œë§Œ ë°°í¬ ì‹¤í–‰
    if: ${{ vars.CHROME_EXTENSION_DEPLOY_ENABLED == 'true' }}
    environment:
      name: chrome-web-store
      url: https://chrome.google.com/webstore/detail/${{ secrets.CHROME_EXTENSION_ID }}
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: chrome-extension-${{ needs.build.outputs.version }}

      - name: Upload to Chrome Web Store
        uses: mnao305/chrome-extension-upload@v5.0.0
        with:
          file-path: extension.zip
          extension-id: ${{ secrets.CHROME_EXTENSION_ID }}
          client-id: ${{ secrets.CHROME_CLIENT_ID }}
          client-secret: ${{ secrets.CHROME_CLIENT_SECRET }}
          refresh-token: ${{ secrets.CHROME_REFRESH_TOKEN }}
          # ìžë™ ê²Œì‹œ (ìˆ˜ë™ íŠ¸ë¦¬ê±°ì—ì„œ publish=true ì„ íƒ ì‹œì—ë§Œ)
          publish: ${{ github.event.inputs.publish == 'true' }}

      - name: Deployment summary
        run: |
          echo "## ðŸš€ Chrome Extension Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ needs.build.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Extension ID | ${{ secrets.CHROME_EXTENSION_ID }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Published | ${{ github.event.inputs.publish == 'true' && 'âœ… Yes' || 'âŒ No (Draft)' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [View in Chrome Web Store](https://chrome.google.com/webstore/detail/${{ secrets.CHROME_EXTENSION_ID }})" >> $GITHUB_STEP_SUMMARY

  notify-skip:
    name: Notify Deploy Skipped
    needs: build
    runs-on: ubuntu-latest
    if: ${{ vars.CHROME_EXTENSION_DEPLOY_ENABLED != 'true' }}
    steps:
      - name: Notify
        run: |
          echo "## â­ï¸ Chrome Extension Deploy Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Chrome Web Store ë°°í¬ê°€ ë¹„í™œì„±í™”ë˜ì–´ ìžˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ë°°í¬ í™œì„±í™” ë°©ë²•" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Repository Variablesì— \`CHROME_EXTENSION_DEPLOY_ENABLED=true\` ì¶”ê°€" >> $GITHUB_STEP_SUMMARY
          echo "2. Repository Secretsì— ë‹¤ìŒ ê°’ ì„¤ì •:" >> $GITHUB_STEP_SUMMARY
          echo "   - \`CHROME_EXTENSION_ID\`" >> $GITHUB_STEP_SUMMARY
          echo "   - \`CHROME_CLIENT_ID\`" >> $GITHUB_STEP_SUMMARY
          echo "   - \`CHROME_CLIENT_SECRET\`" >> $GITHUB_STEP_SUMMARY
          echo "   - \`CHROME_REFRESH_TOKEN\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ë¹Œë“œëœ í™•ìž¥ í”„ë¡œê·¸ëž¨ì€ ì•„í‹°íŒ©íŠ¸ë¡œ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
