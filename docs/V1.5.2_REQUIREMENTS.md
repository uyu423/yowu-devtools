# v1.5.2 Requirements: Icon Converter (SVG/Image to ICO/PNG/WebP/JPEG)

## 문서 개요

본 문서는 **v1.5.2 "Icon Converter"** 도구의 개발 요구사항을 정의합니다.

**도구 ID**: `icon-converter`  
**라우트 경로**: `/icon-converter`  
**도구 이름**: Icon Converter  
**한 줄 설명**: Convert SVG/images to ICO, PNG, WebP, JPEG with multi-size presets

**프로젝트 핵심 원칙**:

- ✅ **로컬 처리**: 모든 변환은 브라우저에서 수행
- ✅ **민감 데이터 외부 전송 금지**: 파일 데이터는 메모리에서만 처리, 저장/전송 없음
- ✅ **설정만 저장/공유**: localStorage와 URL share는 설정만 포함, 이미지 데이터 불포함

---

## 1. 기능 요구사항

### 1.1 사용자 스토리

#### US-1: SVG/이미지 파일을 ICO로 변환

- **As a** 개발자
- **I want to** SVG 파일을 드래그&드롭하여 표준 규격 ICO 파일로 변환
- **So that** Windows/Linux 앱 아이콘 또는 파비콘으로 사용할 수 있다

#### US-2: 멀티 포맷 입력 지원

- **As a** 디자이너
- **I want to** PNG/JPG/WebP 등 다양한 포맷의 이미지를 ICO로 변환
- **So that** 원본 포맷에 관계없이 아이콘을 생성할 수 있다

#### US-3: 표준 사이즈 프리셋 선택

- **As a** 개발자
- **I want to** "Windows Standard", "Favicon Legacy" 등의 프리셋을 선택
- **So that** 플랫폼별 권장 사이즈에 맞는 아이콘을 빠르게 생성할 수 있다

#### US-4: 커스텀 사이즈 세트 지정

- **As a** 고급 사용자
- **I want to** 16/24/32/48/64/128/256 중 필요한 사이즈만 선택
- **So that** 불필요한 사이즈를 제외하고 최적화된 ICO를 생성할 수 있다

#### US-5: 멀티 포맷 출력 지원

- **As a** 개발자
- **I want to** ICO 외에도 PNG/WebP/JPEG로 출력
- **So that** 다양한 플랫폼/용도에 맞는 이미지를 생성할 수 있다

#### US-6: 멀티 사이즈 세트 ZIP 다운로드

- **As a** 개발자
- **I want to** 여러 사이즈의 PNG를 ZIP으로 묶어 다운로드
- **So that** 웹사이트나 앱에 사이즈별 아이콘을 배포할 수 있다

#### US-7: 렌더링 옵션 제어

- **As a** 디자이너
- **I want to** Fit(Contain/Cover/Stretch), 패딩, 배경색을 설정
- **So that** 원하는 스타일의 아이콘을 생성할 수 있다

#### US-8: 실시간 미리보기

- **As a** 사용자
- **I want to** 사이즈별로 생성된 아이콘을 미리보기
- **So that** 투명도/깨짐/비율 문제를 즉시 확인할 수 있다

### 1.2 범위 (In-scope)

#### 입력 포맷

- ✅ SVG
- ✅ PNG
- ✅ JPG/JPEG
- ✅ WebP
- ✅ AVIF (브라우저 지원 시)

#### 출력 포맷

- ✅ ICO (멀티 사이즈 아이콘, 표준 헤더/디렉터리 구조 준수)
- ✅ PNG (단일 또는 멀티 사이즈 세트)
- ✅ WebP (단일 또는 멀티 사이즈 세트)
- ✅ JPEG (단일 또는 멀티 사이즈 세트)
- ✅ ZIP (멀티 사이즈 세트 묶음)

#### 기본 편의 기능

- ✅ 배경: 투명/단색 선택
- ✅ 리사이즈 방식: Contain/Cover/Stretch
- ✅ 패딩: 0~50%
- ✅ 출력 품질: WebP/JPEG 품질 슬라이더 (0~100)
- ✅ 사이즈 프리셋: Windows Standard, Favicon Legacy, Custom
- ✅ 진행률 표시: 사이즈별 진행 상태

### 1.3 비범위 (Out-of-scope)

v1.5.2에서는 다음 기능을 **제외**합니다:

- ❌ ICNS (macOS 아이콘 포맷)
- ❌ CUR (Windows 커서 포맷)
- ❌ BMP 단독 출력
- ❌ SVG 고급 편집 (패스 수정/레이어 편집)
- ❌ 폰트 임베딩/외부 리소스 자동 인라인 (보안·CORS·일관성 이슈)
- ❌ 배치 처리 (여러 파일 동시 변환)

---

## 2. UI/UX 설계

### 2.1 화면 레이아웃

**전체 구조**: Wide Group (`max-w-[90rem]`)

- **좌측 패널**: 입력 및 설정
- **우측 패널**: 미리보기 및 다운로드

### 2.2 UX 흐름

#### Step 1: 파일 입력

- Drag & Drop 또는 File Picker로 파일 선택
- 입력 파일 메타 표시:
  - 파일명
  - 파일 타입 (SVG/PNG/JPG/WebP/AVIF)
  - 원본 크기 (width × height)
  - 투명도 여부 (Has Alpha)
  - 파일 크기 (KB/MB)

#### Step 2: 출력 포맷 선택

- 탭 또는 라디오 버튼:
  - ICO (멀티 사이즈 아이콘)
  - PNG (단일 또는 멀티 사이즈)
  - WebP (단일 또는 멀티 사이즈)
  - JPEG (단일 또는 멀티 사이즈)
- "Export as ZIP" 토글 (멀티 사이즈 모드 시)

#### Step 3: 프리셋/사이즈 설정

- **ICO 모드**:

  - Preset 드롭다운:
    - Windows Standard (권장): 16, 24, 32, 48, 64, 128, 256
    - Favicon Legacy: 16, 32, 48
    - Custom (사용자 지정)
  - 체크리스트로 사이즈 선택/해제
  - 최소 1개, 최대 7개 사이즈 선택 가능
  - 사이즈 범위: 1~256px
  - 256px은 PNG 엔트리로 포함 (표준 관행)

- **기타 포맷 모드**:
  - 단일 사이즈 입력 또는 멀티 사이즈 체크리스트
  - 멀티 사이즈 선택 시 ZIP 옵션 활성화

#### Step 4: 렌더링 옵션

- **Fit**:
  - Contain (기본): 비율 유지, 여백 생김
  - Cover: 비율 유지, 잘림 발생 가능
  - Stretch: 비율 무시, 캔버스 채움
- **Padding**: 0~50% 슬라이더
- **Background**:
  - Transparent (투명, 기본)
  - Solid Color (색상 피커)
- **Quality** (WebP/JPEG만):
  - 슬라이더: 0~100 (기본 85)

#### Step 5: 변환 실행

- "Generate" 버튼 클릭
- 진행률 표시:
  - 전체 진행률 바 (0~100%)
  - 현재 처리 중 사이즈 표시 ("Processing 32×32...")
  - 완료된 사이즈 / 전체 사이즈 ("3 / 7 completed")

#### Step 6: 미리보기 및 다운로드

- **미리보기 그리드**:
  - 사이즈별 썸네일 표시
  - 실제 픽셀 크기로 렌더링 (CSS 확대 없음)
  - 투명 배경은 체크무늬로 표시
  - 각 썸네일 아래에 사이즈 표시 ("16×16", "32×32" 등)
- **다운로드 버튼**:
  - "Download .ico" (ICO 모드)
  - "Download .png" (PNG 단일 모드)
  - "Download .zip" (멀티 사이즈 모드)
  - 파일명 규칙:
    - ICO: `{original-name}.ico`
    - 단일 이미지: `{original-name}_{size}.{ext}`
    - ZIP: `{original-name}_icons.zip`

### 2.3 컴포넌트 구조

```
IconConverterToolPage
├── ToolHeader (제목, 설명, Reset, Share)
├── LeftPanel
│   ├── InputDropzone (파일 선택)
│   ├── FileMetaDisplay (입력 파일 정보)
│   ├── FormatSelector (출력 포맷 선택)
│   ├── PresetSelector (프리셋 선택)
│   ├── SizeChecklist (사이즈 선택)
│   ├── RenderOptionsPanel (Fit, Padding, Background, Quality)
│   └── GenerateButton (생성 버튼 + 진행률)
└── RightPanel
    ├── PreviewGrid (사이즈별 미리보기)
    └── DownloadPanel (다운로드 버튼)
```

### 2.4 에러/경고 메시지 위치

- **파일 입력 오류**: InputDropzone 아래에 ErrorBanner
- **변환 실패**: PreviewGrid 위에 ErrorBanner
- **경고 (외부 리소스/업스케일 등)**: 노란색 경고 배너

---

## 3. 기술 구현 상세

### 3.1 파일 디코딩

#### SVG 처리

1. **Sanitization** (보안 필수):
   - `<script>` 태그 제거
   - `on*` 이벤트 속성 제거 (onclick, onload 등)
   - `foreignObject` 제한 (기본 차단 권장)
   - 외부 리소스 참조 (`<image href="http(s)://...">`) 차단
   - 차단 시: 변환 중단 + "외부 리소스 포함으로 변환 불가" 경고
2. **렌더링**:
   - SVG 문자열 → Blob URL → Image 객체 → ImageBitmap
   - viewBox/width/height 없는 경우: 기본값 512×512로 가정
3. **Fallback**:
   - 브라우저 렌더링 실패 시: 추후 `@resvg/resvg-wasm` lazy-load 고려 (v1.5.2는 제외)

#### Raster 이미지 (PNG/JPG/WebP/AVIF)

- `createImageBitmap()` 사용 (성능 최적화)
- CORS/taint 방지: 로컬 파일만 허용

### 3.2 리사이징

#### OffscreenCanvas 사용 (권장)

- Web Worker에서 `OffscreenCanvas`로 렌더링
- 각 사이즈별로 독립적인 Canvas 생성
- Fit 모드에 따른 렌더링:
  - **Contain**: 비율 유지, 중앙 정렬, 여백 생김
  - **Cover**: 비율 유지, 중앙 정렬, 잘림 가능
  - **Stretch**: 비율 무시, 캔버스 채움
- Padding 적용: 실제 렌더링 영역을 (100 - padding)%로 축소
- Background 적용:
  - Transparent: Alpha 채널 유지
  - Solid: `ctx.fillRect()` 먼저 실행 후 이미지 렌더링

#### Fallback (Worker/OffscreenCanvas 미지원)

- 메인 스레드에서 일반 Canvas 사용
- 사이즈별로 `await`로 순차 처리 (프리즈 완화)

### 3.3 ICO 생성

#### ICO 파일 구조 (표준 규격)

```
ICONDIR Header (6 bytes)
├── idReserved: 0 (2 bytes)
├── idType: 1 (ICO) (2 bytes)
└── idCount: N (사이즈 개수) (2 bytes)

ICONDIRENTRY × N (16 bytes each)
├── bWidth: width (1 byte, 0 means 256)
├── bHeight: height (1 byte, 0 means 256)
├── bColorCount: 0 (PNG 엔트리) (1 byte)
├── bReserved: 0 (1 byte)
├── wPlanes: 1 (2 bytes)
├── wBitCount: 32 (2 bytes)
├── dwBytesInRes: PNG 데이터 크기 (4 bytes)
└── dwImageOffset: PNG 데이터 오프셋 (4 bytes)

Image Data (PNG 포맷)
├── PNG 1 (size 1)
├── PNG 2 (size 2)
└── ...
```

#### 구현 세부사항

- **사이즈 범위 제한**: 1~256px (표준 범위)
- **기본 프리셋**:
  - Windows Standard: `[16, 24, 32, 48, 64, 128, 256]`
  - Favicon Legacy: `[16, 32, 48]`
- **256px 처리**: PNG 엔트리로 포함 (사실상 표준 관행)
- **ICO 모드**:
  - `modern_png` (기본): 모든 엔트리를 PNG로 저장 (구현 단순, 현대 OS 호환 우수)
  - `compat` (v1.5.2에서는 옵션만 노출, 구현은 추후): BMP/DIB + AND mask 지원

### 3.4 ZIP 생성

#### 라이브러리 선택

- `fflate` 사용 (경량, 빠름, 브라우저 최적화)

#### 파일명 규칙

- ICO 멀티 사이즈: `icon_{size}.png` (예: `icon_16.png`, `icon_32.png`)
- 기타 포맷: `{original-name}_{size}.{ext}`

#### ZIP 구조

```
icons.zip
├── icon_16.png
├── icon_32.png
├── icon_48.png
├── ...
└── (optional) meta.json (파일 정보)
```

### 3.5 Web Worker 파이프라인

#### Worker 메시지 프로토콜

```typescript
// Main → Worker
type WorkerRequest = {
  type: 'generate';
  sourceImageBitmap: ImageBitmap; // Transferable
  settings: IconConverterSettings;
};

// Worker → Main
type WorkerProgress = {
  type: 'progress';
  current: number;
  total: number;
  currentSize: number; // 현재 처리 중 사이즈
};

type WorkerResult = {
  type: 'result';
  output: Uint8Array; // ICO/ZIP bytes
  preview: { size: number; dataUrl: string }[]; // 미리보기용
};

type WorkerError = {
  type: 'error';
  message: string;
};
```

#### Worker 내부 흐름

1. ImageBitmap 수신 (Transferable로 메모리 효율적 전송)
2. 각 사이즈별로:
   - OffscreenCanvas 생성
   - 리사이징 + Fit/Padding/Background 적용
   - PNG/WebP/JPEG 인코딩
   - Progress 메시지 전송
3. ICO/ZIP 생성
4. Result 메시지 전송 (Transferable)

---

## 4. 데이터 모델

### 4.1 localStorage Schema

**키**: `tool:icon-converter:v1`

**값** (설정만 저장, 이미지 데이터 저장 금지):

```typescript
type IconConverterSettings = {
  // 출력 포맷
  outputFormat: 'ico' | 'png' | 'webp' | 'jpeg';

  // 프리셋 및 사이즈
  preset: 'windows_standard' | 'favicon_legacy' | 'custom';
  sizes: number[]; // 예: [16, 24, 32, 48, 64, 128, 256]

  // 렌더링 옵션
  fit: 'contain' | 'cover' | 'stretch';
  padding: number; // 0~50 (%)
  background: { type: 'transparent' } | { type: 'solid'; color: string }; // #RRGGBB

  // 품질 (WebP/JPEG만)
  quality?: number; // 0~100, 기본값 85

  // 멀티 사이즈 ZIP 출력
  exportZip: boolean;

  // ICO 모드 (v1.5.2에서는 modern_png만)
  icoMode: 'modern_png' | 'compat';
};
```

### 4.2 Share Schema (URL Query Parameter)

#### URL 형식

- **쿼리 파라미터 방식**: `?d=<compressedPayload>`
- **전체 URL 예시**: `https://tools.yowu.dev/icon-converter?d=<compressedPayload>`

#### Payload 구조 (Envelope)

```typescript
{
  "v": 1,                          // Payload 버전
  "tool": "icon-converter",        // 도구 ID
  "state": IconConverterSettings   // 도구별 설정 (아래 참조)
}
```

#### 인코딩 규칙

1. `IconConverterSettings` 객체를 JSON 문자열로 변환
2. Envelope 구조로 감싸기: `{ v: 1, tool: "icon-converter", state: settings }`
3. **lz-string 압축**: `LZString.compressToEncodedURIComponent(JSON.stringify(envelope))`
4. URL 생성: `${window.location.origin}/icon-converter?d=${compressed}`

#### 디코딩 규칙

1. URL에서 `?d=` 파라미터 추출
2. **lz-string 압축 해제**: `LZString.decompressFromEncodedURIComponent(payload)`
3. JSON 파싱: `JSON.parse(decompressed)`
4. Envelope 검증:
   - `v === 1` 확인
   - `tool === "icon-converter"` 확인
5. `state` 필드를 도구 상태로 복원

#### 디코딩 실패 시

- 사용자에게 "공유 링크가 손상되었거나 버전이 맞지 않습니다" 안내
- Toast 알림 표시 (`common.sharedUrlInvalid`)
- 도구 기본 상태로 fallback

#### URL 길이 제한

- **최대 길이**: `MAX_SHARE_URL_LENGTH = 8000` (브라우저/GitHub Pages 호환성)
- URL이 제한을 초과하는 경우:
  - ShareModal에 경고 배너 표시
  - "링크 복사" / "공유하기" 버튼 비활성화
  - 사용자에게 입력 크기 축소 권장

#### 예시

```typescript
// 1. Settings 준비
const settings: IconConverterSettings = {
  outputFormat: 'ico',
  preset: 'windows_standard',
  sizes: [16, 32, 48, 64, 128, 256],
  fit: 'contain',
  padding: 10,
  background: { type: 'transparent' },
  exportZip: false,
  icoMode: 'modern_png',
};

// 2. Envelope 생성
const envelope = {
  v: 1,
  tool: 'icon-converter',
  state: settings,
};

// 3. 압축 및 URL 생성
const compressed = LZString.compressToEncodedURIComponent(
  JSON.stringify(envelope)
);
const shareUrl = `${window.location.origin}/icon-converter?d=${compressed}`;

// 결과 예시:
// https://tools.yowu.dev/icon-converter?d=N4IgdghgtgpiBcIDKBXAlhAzhABAJwgCcIALAFwBsBjAewBkBZPMAYxAFciQAnA...
```

#### 상태 복원 우선순위 (useToolState 훅)

1. **Priority 1**: `location.state` (직접 네비게이션, 예: API Tester → JSON Viewer)
2. **Priority 2**: URL 쿼리 파라미터 `?d=` (공유 링크)
3. **Priority 3**: localStorage (이전 세션 복원)
4. **Priority 4**: 도구 기본 상태 (`DEFAULT_STATE`)

### 4.3 i18n 키 목록

**파일 위치**: `apps/web/src/i18n/*.ts` (en-US, ko-KR, ja-JP, zh-CN, es-ES)

#### 필수 키

```typescript
// 도구 메타
'tools.iconConverter.title'; // "Icon Converter"
'tools.iconConverter.description'; // "Convert SVG/images to ICO, PNG, WebP, JPEG"

// 입력
'tools.iconConverter.input.dropHere'; // "Drop image here or click to browse"
'tools.iconConverter.input.pickFile'; // "Pick File"
'tools.iconConverter.input.fileMeta.name'; // "File Name"
'tools.iconConverter.input.fileMeta.type'; // "File Type"
'tools.iconConverter.input.fileMeta.size'; // "File Size"
'tools.iconConverter.input.fileMeta.dimensions'; // "Dimensions"
'tools.iconConverter.input.fileMeta.hasAlpha'; // "Has Alpha"

// 출력 포맷
'tools.iconConverter.output.format'; // "Output Format"
'tools.iconConverter.output.format.ico'; // "ICO (Multi-size Icon)"
'tools.iconConverter.output.format.png'; // "PNG"
'tools.iconConverter.output.format.webp'; // "WebP"
'tools.iconConverter.output.format.jpeg'; // "JPEG"
'tools.iconConverter.output.exportZip'; // "Export as ZIP"

// 프리셋
'tools.iconConverter.preset.label'; // "Preset"
'tools.iconConverter.preset.windowsStandard'; // "Windows Standard (16-256)"
'tools.iconConverter.preset.faviconLegacy'; // "Favicon Legacy (16,32,48)"
'tools.iconConverter.preset.custom'; // "Custom"

// 사이즈
'tools.iconConverter.sizes.label'; // "Sizes"
'tools.iconConverter.sizes.selectAll'; // "Select All"
'tools.iconConverter.sizes.deselectAll'; // "Deselect All"

// 렌더링 옵션
'tools.iconConverter.options.fit'; // "Fit"
'tools.iconConverter.options.fit.contain'; // "Contain (Keep ratio, add padding)"
'tools.iconConverter.options.fit.cover'; // "Cover (Keep ratio, may crop)"
'tools.iconConverter.options.fit.stretch'; // "Stretch (Fill canvas, ignore ratio)"
'tools.iconConverter.options.padding'; // "Padding (%)"
'tools.iconConverter.options.background'; // "Background"
'tools.iconConverter.options.background.transparent'; // "Transparent"
'tools.iconConverter.options.background.solid'; // "Solid Color"
'tools.iconConverter.options.quality'; // "Quality (0-100)"

// ICO 모드
'tools.iconConverter.ico.mode'; // "ICO Mode"
'tools.iconConverter.ico.mode.modernPng'; // "Modern PNG (Recommended)"
'tools.iconConverter.ico.mode.compat'; // "Compatibility (Coming soon)"

// 액션
'tools.iconConverter.generate'; // "Generate"
'tools.iconConverter.generating'; // "Generating..."
'tools.iconConverter.progress'; // "{current} / {total} completed"
'tools.iconConverter.processingSize'; // "Processing {size}×{size}..."

// 다운로드
'tools.iconConverter.download'; // "Download"
'tools.iconConverter.download.ico'; // "Download .ico"
'tools.iconConverter.download.png'; // "Download .png"
'tools.iconConverter.download.webp'; // "Download .webp"
'tools.iconConverter.download.jpeg'; // "Download .jpeg"
'tools.iconConverter.download.zip'; // "Download .zip"

// 에러
'tools.iconConverter.error.unsupportedFormat'; // "Unsupported file format"
'tools.iconConverter.error.svgExternalRefBlocked'; // "SVG contains external resources (blocked for security)"
'tools.iconConverter.error.decodeFailed'; // "Failed to decode image"
'tools.iconConverter.error.renderFailed'; // "Failed to render image"
'tools.iconConverter.error.noSizeSelected'; // "Please select at least one size"
'tools.iconConverter.error.invalidSize'; // "Size must be between 1 and 256"

// 경고
'tools.iconConverter.warning.largeImage'; // "Large image may cause performance issues"
'tools.iconConverter.warning.upscale'; // "Upscaling from {original}px to {target}px may reduce quality"
'tools.iconConverter.warning.svgComplexity'; // "Complex SVG may not render correctly in all browsers"

// 미리보기
'tools.iconConverter.preview.title'; // "Preview"
'tools.iconConverter.preview.noPreview'; // "Generate icons to see preview"

// SEO 메타 정보
'meta.iconConverter.title'; // "Icon Converter"
'meta.iconConverter.description'; // "Free online icon converter. Convert SVG, PNG, JPG to ICO, PNG, WebP, JPEG with multi-size presets. Generate Windows app icons, favicons, and more. All processing happens in your browser - no data sent to servers."
```

**참고**: `meta.iconConverter.*` 키는 빌드 시 SEO 메타 태그 생성에 사용되며, 모든 언어 파일에 추가해야 합니다.

---

## 5. 성능 / 보안 / 프라이버시

### 5.1 성능 최적화

#### Web Worker + OffscreenCanvas

- ✅ 멀티 사이즈 렌더링은 Web Worker에서 처리 (UI 블로킹 방지)
- ✅ OffscreenCanvas 사용 (메인 스레드 Canvas보다 빠름)
- ✅ 미지원 브라우저: 메인 스레드 fallback (사이즈별 `await`로 프리즈 완화)

#### 진행률 표시

- ✅ 전체 진행률 바 (0~100%)
- ✅ 현재 처리 중 사이즈 표시 ("Processing 32×32...")
- ✅ 완료된 사이즈 / 전체 사이즈 ("3 / 7 completed")

#### 디코딩 최적화

- ✅ `createImageBitmap()` 우선 사용 (성능 유리)
- ✅ SVG는 Blob URL로 변환 후 ImageBitmap 생성

#### 메모리 관리

- ✅ 생성된 Blob URL은 사용 후 `URL.revokeObjectURL()` 호출
- ✅ ImageBitmap은 Transferable로 Worker에 전송 (메모리 복사 없음)

### 5.2 보안

#### SVG Sanitization (필수)

- ✅ `<script>` 태그 제거
- ✅ `on*` 이벤트 속성 제거 (onclick, onload, onerror 등)
- ✅ `<foreignObject>` 제한 (기본 차단 권장)
- ✅ 외부 리소스 참조 차단:
  - `<image href="http(s)://...">` 차단
  - `<use href="http(s)://...">` 차단
  - CSS `url()` 외부 참조 차단
- ✅ 차단 시: 변환 중단 + 경고 메시지 표시

#### CORS/Canvas Taint 방지

- ✅ 로컬 파일만 허용 (외부 URL 불허)
- ✅ `crossOrigin` 설정 없이 로컬 Blob URL만 사용

#### 네트워크 전송 금지

- ✅ 모든 처리는 브라우저에서 수행
- ✅ 파일 데이터를 서버로 전송하지 않음

### 5.3 프라이버시

#### 데이터 저장/전송 금지

- ✅ 업로드 파일은 메모리에서만 처리
- ✅ localStorage에 이미지 데이터 저장 금지
- ✅ URL share에 이미지 데이터 포함 금지
- ✅ 로그/분석에 이미지 데이터 전송 금지

#### 설정만 저장/공유

- ✅ localStorage: `IconConverterSettings`만 저장
- ✅ URL share: `IconConverterSettings`만 인코딩

---

## 6. 엣지 케이스 및 테스트

### 6.1 엣지 케이스

#### EC-1: SVG에 외부 리소스 포함

- **입력**: SVG에 `<image href="https://example.com/logo.png">` 포함
- **동작**: 변환 차단 + "외부 리소스 포함으로 변환 불가" 경고
- **이유**: CORS/taint 위험, 외부 의존성

#### EC-2: SVG viewBox/width/height 없음

- **입력**: SVG에 `<svg>` 속성 누락
- **동작**: 기본값 512×512로 렌더 후 다운스케일
- **경고**: "SVG 크기 정보 없음, 512×512로 가정"

#### EC-3: 작은 원본 이미지 업스케일

- **입력**: 32×32 PNG를 256×256으로 변환
- **동작**: 업스케일 수행
- **경고**: "업스케일로 품질 저하 가능 (32px → 256px)"

#### EC-4: 투명도 처리

- **입력**: Alpha 채널 있는 PNG + 단색 배경 선택
- **동작**: Alpha 합성으로 배경색 채움
- **검증**: 투명 영역이 배경색으로 올바르게 채워짐

#### EC-5: 고 DPI 디스플레이

- **입력**: Retina 디스플레이에서 프리뷰 표시
- **동작**: CSS 크기와 실제 픽셀 크기 분리
- **검증**: 16×16 아이콘이 16px로 표시 (32px 아님)

#### EC-6: 사이즈 0개 선택

- **입력**: 모든 사이즈 체크 해제
- **동작**: Generate 버튼 비활성화
- **경고**: "최소 1개 사이즈 선택 필요"

#### EC-7: 중복 사이즈 선택

- **입력**: Custom 모드에서 32, 32, 48 입력
- **동작**: 중복 제거 (32, 48만 유지)

#### EC-8: 범위 초과 사이즈

- **입력**: 0, 300, -10 입력
- **동작**: 필터링 (1~256 범위만 허용)
- **경고**: "사이즈는 1~256 범위만 허용"

#### EC-9: 매우 큰 원본 이미지

- **입력**: 4000×4000 PNG (50MB)
- **동작**: 경고 표시 + 처리 진행
- **경고**: "큰 이미지로 메모리 사용량 증가 가능"

#### EC-10: Worker 미지원 브라우저

- **입력**: IE11 또는 구형 브라우저
- **동작**: 메인 스레드 fallback 자동 전환
- **경고**: "성능 최적화 미지원, 처리 시간 증가 가능"

### 6.2 테스트 체크리스트

#### 기능 테스트

- [ ] PNG 입력 → ICO 출력 다운로드가 정상이며 Windows에서 아이콘으로 인식
- [ ] SVG 입력 → 16/32/48/256 포함 ICO 생성
- [ ] JPG 입력 → PNG 멀티 사이즈 ZIP 생성
- [ ] WebP 입력 → WebP 단일 출력
- [ ] "Windows Standard preset"이 기본 선택되고 권장 사이즈 세트가 맞음
- [ ] "Favicon Legacy preset" 선택 시 16/32/48만 선택됨
- [ ] Custom 모드에서 사이즈 체크/언체크 정상 동작
- [ ] 사이즈 0개 선택 시 Generate 버튼 비활성화
- [ ] 중복 사이즈 입력 시 중복 제거
- [ ] 범위 초과 사이즈 (0, 300) 필터링

#### 렌더링 테스트

- [ ] Fit: Contain - 비율 유지, 여백 생김
- [ ] Fit: Cover - 비율 유지, 잘림 발생
- [ ] Fit: Stretch - 비율 무시, 캔버스 채움
- [ ] Padding 0% - 여백 없음
- [ ] Padding 50% - 실제 이미지가 절반 크기로 축소
- [ ] 투명 배경 - Alpha 채널 유지
- [ ] 단색 배경 - Alpha 합성으로 배경색 채움
- [ ] WebP Quality 100 - 최고 품질
- [ ] WebP Quality 10 - 낮은 품질 (작은 파일 크기)

#### 엣지 케이스 테스트

- [ ] SVG 외부 리소스 차단/경고 문구 노출
- [ ] SVG viewBox 없음 - 512×512 기본값 적용
- [ ] 작은 원본 업스케일 - 경고 문구 노출
- [ ] 큰 이미지 (4000×4000) - 경고 문구 노출 + 처리 성공
- [ ] Worker 미지원 환경 - fallback 동작 확인

#### UI/UX 테스트

- [ ] 드래그&드롭으로 파일 선택
- [ ] File picker로 파일 선택
- [ ] 입력 파일 메타 정보 표시 (이름, 타입, 크기, 투명도)
- [ ] 진행률 바 정상 표시 (0~100%)
- [ ] 현재 처리 중 사이즈 표시
- [ ] 미리보기 그리드 정상 표시 (사이즈별 썸네일)
- [ ] 다운로드 버튼 클릭 시 파일 다운로드
- [ ] 파일명 규칙 일관성 (icon\_{size}.png 등)

#### 성능 테스트

- [ ] 7개 사이즈 ICO 생성 시간 < 3초 (일반 SVG)
- [ ] Worker 사용 시 UI 프리징 없음
- [ ] Fallback 모드에서도 최소 기능 동작
- [ ] 메모리 누수 없음 (생성 후 Blob URL revoke 확인)

#### 크로스 브라우저 테스트

- [ ] Chrome: Worker + OffscreenCanvas 정상 동작
- [ ] Firefox: Worker + OffscreenCanvas 정상 동작
- [ ] Safari: Worker fallback 정상 동작 (OffscreenCanvas 미지원)
- [ ] Edge: 정상 동작

---

## 7. 구현 태스크

### 7.1 프로젝트 구조 생성

**경로**: `apps/web/src/tools/icon-converter/`

```
icon-converter/
├── index.tsx                 # Tool entry + ToolDefinition
├── ToolPage.tsx              # 메인 페이지 컴포넌트
├── components/
│   ├── InputDropzone.tsx     # 파일 입력
│   ├── FileMetaDisplay.tsx   # 파일 정보 표시
│   ├── FormatSelector.tsx    # 출력 포맷 선택
│   ├── PresetSelector.tsx    # 프리셋 선택
│   ├── SizeChecklist.tsx     # 사이즈 선택
│   ├── RenderOptionsPanel.tsx # 렌더링 옵션
│   ├── GenerateButton.tsx    # 생성 버튼 + 진행률
│   ├── PreviewGrid.tsx       # 미리보기
│   └── DownloadPanel.tsx     # 다운로드
├── logic/
│   ├── decodeImage.ts        # 이미지 디코딩
│   ├── sanitizeSvg.ts        # SVG sanitization
│   ├── renderResizedBitmap.ts # 리사이징
│   ├── exportIco.ts          # ICO 생성
│   ├── exportZip.ts          # ZIP 생성
│   └── constants.ts          # 프리셋, 기본값
└── worker/
    └── iconWorker.ts         # Web Worker
```

### 7.2 Task Breakdown

#### Phase 1: 기본 구조 및 UI (3일)

**Task 1.1: Tool scaffold 생성**

- [ ] `apps/web/src/tools/icon-converter/` 디렉토리 생성
- [ ] `index.tsx` - ToolDefinition 작성 (id, path, icon, Component)
- [ ] `ToolPage.tsx` - 기본 레이아웃 (ToolHeader + 좌우 패널)
- [ ] `apps/web/src/tools/index.ts`에 도구 등록
- [ ] `components/` 디렉토리 및 빈 컴포넌트 파일 생성

**Task 1.1b: 상태 관리 및 공유 기능 통합**

- [ ] `useToolState` 훅 사용:
  - `toolId: 'icon-converter'`
  - `defaultState: DEFAULT_SETTINGS`
  - `shareStateFilter` 옵션 설정 (설정만 공유, 이미지 데이터 제외)
- [ ] `ShareModal` 통합:
  - `useShareModal` 훅 사용
  - `ToolHeader`에 `onShare` 핸들러 연결
  - `ShareModal` 컴포넌트 렌더링
- [ ] localStorage 자동 저장/복원 확인
- [ ] URL share (`?d=`) 파라미터 복원 확인

**Task 1.2: InputDropzone 구현**

- [ ] Drag & Drop 이벤트 핸들러
- [ ] File picker 버튼
- [ ] 파일 타입 검증 (SVG/PNG/JPG/WebP/AVIF)
- [ ] 드롭 영역 시각적 피드백

**Task 1.3: FileMetaDisplay 구현**

- [ ] 파일명, 타입, 크기 표시
- [ ] 원본 이미지 크기 (width × height)
- [ ] Alpha 채널 존재 여부 표시

**Task 1.4: FormatSelector 구현**

- [ ] 라디오 버튼: ICO / PNG / WebP / JPEG
- [ ] "Export as ZIP" 토글

**Task 1.5: PresetSelector 구현**

- [ ] 드롭다운: Windows Standard / Favicon Legacy / Custom
- [ ] Preset 선택 시 sizes 자동 업데이트

**Task 1.6: SizeChecklist 구현**

- [ ] 체크박스 리스트 (16, 24, 32, 48, 64, 128, 256)
- [ ] "Select All" / "Deselect All" 버튼
- [ ] 최소 1개 선택 검증

**Task 1.7: RenderOptionsPanel 구현**

- [ ] Fit 선택 (Contain / Cover / Stretch)
- [ ] Padding 슬라이더 (0~50%)
- [ ] Background 선택 (Transparent / Solid Color + 색상 피커)
- [ ] Quality 슬라이더 (0~100, WebP/JPEG만 표시)

#### Phase 2: 핵심 로직 구현 (5일)

**Task 2.1: decodeImage.ts 구현**

- [ ] 파일 타입 감지 (MIME type + magic number)
- [ ] SVG: Blob URL 생성 → Image → ImageBitmap
- [ ] Raster: File → createImageBitmap
- [ ] 에러 처리 (unsupported format, decode failed)

**Task 2.2: sanitizeSvg.ts 구현**

- [ ] `<script>` 태그 제거
- [ ] `on*` 이벤트 속성 제거
- [ ] `<foreignObject>` 차단
- [ ] 외부 리소스 참조 검사 (`<image href="http">`, `<use href="http">`, CSS `url()`)
- [ ] 차단 시 에러 반환

**Task 2.3: renderResizedBitmap.ts 구현**

- [ ] OffscreenCanvas 또는 일반 Canvas 생성
- [ ] Fit 모드별 렌더링 로직:
  - Contain: 비율 유지, 중앙 정렬
  - Cover: 비율 유지, 중앙 정렬, 잘림
  - Stretch: 비율 무시, 캔버스 채움
- [ ] Padding 적용 (렌더링 영역 축소)
- [ ] Background 적용 (투명/단색)
- [ ] PNG/WebP/JPEG 인코딩 (Canvas.toBlob)

**Task 2.4: exportIco.ts 구현**

- [ ] ICONDIR 헤더 생성 (6 bytes)
- [ ] ICONDIRENTRY 배열 생성 (16 bytes × N)
- [ ] PNG 데이터 blob concat
- [ ] 오프셋 계산 (헤더 + 엔트리 + 이전 이미지 크기 누적)
- [ ] Uint8Array로 최종 ICO 파일 생성
- [ ] 256px 처리 (bWidth = 0, bHeight = 0)

**Task 2.5: exportZip.ts 구현**

- [ ] `fflate` 라이브러리 추가 (`pnpm add fflate`)
- [ ] 파일명 규칙: `icon_{size}.{ext}`
- [ ] ZIP 생성 (fflate.zipSync)
- [ ] Blob 반환

**Task 2.6: constants.ts 작성**

- [ ] PRESETS 정의:
  ```typescript
  PRESETS = {
    windows_standard: [16, 24, 32, 48, 64, 128, 256],
    favicon_legacy: [16, 32, 48],
  };
  ```
- [ ] DEFAULT_SETTINGS
- [ ] SIZE_RANGE: { min: 1, max: 256 }

#### Phase 3: Web Worker 구현 (3일)

**Task 3.1: iconWorker.ts 기본 구조**

- [ ] Worker 메시지 프로토콜 정의 (Request, Progress, Result, Error)
- [ ] onmessage 핸들러
- [ ] postMessage 래퍼 함수

**Task 3.2: Worker 내 렌더링 파이프라인**

- [ ] ImageBitmap 수신 (Transferable)
- [ ] 각 사이즈별 루프:
  - OffscreenCanvas 생성
  - renderResizedBitmap 호출
  - PNG 인코딩
  - Progress 메시지 전송
- [ ] ICO/ZIP 생성
- [ ] Result 메시지 전송 (Transferable)

**Task 3.3: ToolPage에서 Worker 호출**

- [ ] Worker 인스턴스 생성
- [ ] ImageBitmap transfer로 전송
- [ ] Progress 메시지 수신 → UI 업데이트
- [ ] Result 메시지 수신 → 다운로드 버튼 활성화
- [ ] Error 메시지 수신 → ErrorBanner 표시

**Task 3.4: Fallback 구현 (Worker 미지원)**

- [ ] `typeof Worker !== 'undefined'` 체크
- [ ] Fallback: 메인 스레드에서 순차 처리
- [ ] 사이즈별 `await` + requestAnimationFrame으로 UI 프리즈 완화

#### Phase 4: 미리보기 및 다운로드 (2일)

**Task 4.1: PreviewGrid 구현**

- [ ] 사이즈별 썸네일 표시 (Grid 레이아웃)
- [ ] 투명 배경은 체크무늬로 표시
- [ ] 실제 픽셀 크기로 렌더링 (CSS 확대 없음)
- [ ] 사이즈 라벨 표시 ("16×16", "32×32" 등)

**Task 4.2: DownloadPanel 구현**

- [ ] Blob URL 생성 (`URL.createObjectURL`)
- [ ] `<a download>` 태그로 다운로드 트리거
- [ ] 파일명 규칙 적용
- [ ] Blob URL revoke (`URL.revokeObjectURL`) - 메모리 관리

**Task 4.3: GenerateButton 구현**

- [ ] "Generate" 버튼 + 진행률 표시
- [ ] 진행률 바 (0~100%)
- [ ] 현재 처리 중 사이즈 표시
- [ ] 완료/에러 상태 표시

#### Phase 5: i18n 및 도구 등록 (1일)

**Task 5.1: i18n 키 추가**

- [ ] `apps/web/src/i18n/en-US.ts`에 모든 키 추가 (섹션 4.3 참조)
- [ ] `ko-KR.ts`에 한국어 번역 추가
- [ ] `ja-JP.ts`에 일본어 번역 추가 (임시: en-US 복사 + TODO)
- [ ] `zh-CN.ts`에 중국어 번역 추가 (임시: en-US 복사 + TODO)
- [ ] `es-ES.ts`에 스페인어 번역 추가 (임시: en-US 복사 + TODO)

**Task 5.2: SEO 최적화**

- [ ] `vite-plugin-generate-routes.ts`에 도구 정보 추가:
  ```typescript
  {
    id: 'icon-converter',
    path: '/icon-converter',
    title: 'Icon Converter',
    description: 'Convert SVG/images to ICO, PNG, WebP, JPEG',
    seoDescription: 'Free online icon converter. Convert SVG, PNG, JPG to ICO, PNG, WebP, JPEG with multi-size presets. Generate Windows app icons, favicons, and more. All processing happens in your browser - no data sent to servers.',
    keywords: [
      'icon converter',
      'svg to ico',
      'png to ico',
      'ico generator',
      'favicon generator',
      'app icon generator',
      'image converter',
      'online icon tool',
    ],
    features: [
      'Convert SVG/PNG/JPG to ICO',
      'Multi-size icon generation',
      'Windows/Favicon presets',
      'Custom size selection',
      'Export as PNG/WebP/JPEG',
      'ZIP export for multi-size sets',
    ],
  }
  ```

**Task 5.3: 도구 아이콘 선택**

- [ ] Lucide React 아이콘 선택 (예: `ImageIcon`, `FileImage`, `Sparkles`)
- [ ] `index.tsx`의 ToolDefinition에 icon 추가

#### Phase 6: 테스트 및 QA (3일)

**Task 6.1: 단위 테스트 작성 (선택)**

- [ ] `exportIco.ts` - ICO 바이너리 구조 검증 (헤더, 엔트리, 오프셋)
- [ ] `sanitizeSvg.ts` - 외부 리소스 차단 검증
- [ ] `renderResizedBitmap.ts` - Fit 모드별 렌더링 검증

**Task 6.2: 기능 테스트**

- [ ] 섹션 6.2의 "기능 테스트" 체크리스트 수행

**Task 6.3: 엣지 케이스 테스트**

- [ ] 섹션 6.1의 엣지 케이스 10가지 검증

**Task 6.4: 크로스 브라우저 테스트**

- [ ] Chrome, Firefox, Safari, Edge에서 정상 동작 확인

**Task 6.5: 성능 테스트**

- [ ] 7개 사이즈 ICO 생성 시간 측정
- [ ] 메모리 누수 검사 (Blob URL revoke 확인)

#### Phase 7: 문서 업데이트 및 배포 (1일)

**Task 7.1: 문서 업데이트**

- [ ] `README.md` - 도구 목록에 "Icon Converter" 추가
- [ ] `SAS.md` - v1.5.2 기능 추가
- [ ] `RELEASE_NOTES.md` - v1.5.2 릴리스 노트 작성

**Task 7.2: 최종 빌드 검증**

- [ ] `npm run lint` - Lint 오류 없음
- [ ] `npm run build` - 빌드 성공
- [ ] `dist/icon-converter/index.html` 생성 확인
- [ ] `dist/sitemap.xml`에 `/icon-converter` 추가 확인

**Task 7.3: 배포**

- [ ] `main` 브랜치에 병합
- [ ] GitHub Actions 자동 배포 확인
- [ ] 프로덕션 환경 검증

---

## 8. 도구 등록 및 SEO

### 8.1 도구 레지스트리

**파일**: `apps/web/src/tools/index.ts`

```typescript
import { iconConverterTool } from './icon-converter';

export const tools: ToolDefinition[] = [
  // ... 기존 도구들
  iconConverterTool,
];
```

### 8.2 SEO 메타 정보

**파일**: `apps/web/vite-plugin-generate-routes.ts`

**추가 내용** (tools 배열):

```typescript
{
  id: 'icon-converter',
  path: '/icon-converter',
  title: 'Icon Converter',
  description: 'Convert SVG/images to ICO, PNG, WebP, JPEG',
  seoDescription: 'Free online icon converter. Convert SVG, PNG, JPG to ICO, PNG, WebP, JPEG with multi-size presets. Generate Windows app icons, favicons, and more. All processing happens in your browser - no data sent to servers.',
  keywords: [
    'icon converter',
    'svg to ico',
    'png to ico',
    'ico generator',
    'favicon generator',
    'app icon generator',
    'image converter',
    'online icon tool',
    'multi-size icon',
    'windows icon',
  ],
  features: [
    'Convert SVG/PNG/JPG to ICO',
    'Multi-size icon generation',
    'Windows/Favicon presets',
    'Custom size selection',
    'Export as PNG/WebP/JPEG',
    'ZIP export for multi-size sets',
    'Real-time preview',
  ],
}
```

### 8.3 Sitemap Priority

**기본값**: `1.0` (개별 도구 페이지)

---

## 9. 의존성 및 라이브러리

### 9.1 새로 추가할 라이브러리

#### fflate

- **용도**: ZIP 파일 생성
- **설치**: `pnpm add fflate`
- **이유**: 경량 (10KB gzipped), 빠름, 브라우저 최적화
- **대안**: JSZip (무겁고 느림)

### 9.2 기존 라이브러리 활용

- ✅ `sharp` - 서버 사이드만 사용 (브라우저 불가), v1.5.2에서는 미사용
- ✅ `to-ico` - 서버 사이드만 사용 (브라우저 불가), v1.5.2에서는 미사용
- ✅ Canvas API (브라우저 네이티브)
- ✅ ImageBitmap (브라우저 네이티브)
- ✅ Web Worker (브라우저 네이티브)

**참고**: `@resvg/resvg-wasm`는 v1.5.2에서 제외 (무겁고 복잡함, 추후 옵션으로 고려)

---

## 10. 개발 일정 (예상)

| Phase    | 기간     | 태스크                |
| -------- | -------- | --------------------- |
| Phase 1  | 3일      | 기본 구조 및 UI       |
| Phase 2  | 5일      | 핵심 로직 구현        |
| Phase 3  | 3일      | Web Worker 구현       |
| Phase 4  | 2일      | 미리보기 및 다운로드  |
| Phase 5  | 1일      | i18n 및 도구 등록     |
| Phase 6  | 3일      | 테스트 및 QA          |
| Phase 7  | 1일      | 문서 업데이트 및 배포 |
| **합계** | **18일** | **약 3.5주**          |

---

## 11. 참고 자료

### 11.1 ICO 파일 포맷 규격

- [Microsoft ICO Format Specification](<https://en.wikipedia.org/wiki/ICO_(file_format)>)
- [ICO File Structure](https://www.daubnet.com/en/file-format-ico)

### 11.2 브라우저 API

- [Canvas API](https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API)
- [ImageBitmap](https://developer.mozilla.org/en-US/docs/Web/API/ImageBitmap)
- [OffscreenCanvas](https://developer.mozilla.org/en-US/docs/Web/API/OffscreenCanvas)
- [Web Workers](https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API)
- [createImageBitmap](https://developer.mozilla.org/en-US/docs/Web/API/createImageBitmap)

### 11.3 라이브러리

- [fflate](https://github.com/101arrowz/fflate)

---

## 12. 추가 고려사항

### 12.1 향후 개선 가능 항목 (v1.5.3+)

- 배치 처리 (여러 파일 동시 변환)
- ICNS (macOS) 출력 지원
- CUR (Windows 커서) 출력 지원
- SVG 고급 옵션 (`@resvg/resvg-wasm` 통합)
- 드래그&드롭 미리보기 (드롭 전에 이미지 표시)
- 히스토리 (최근 변환한 파일 목록)
- 템플릿 저장 (자주 쓰는 설정 프리셋)

### 12.2 알려진 제약사항

- Safari는 OffscreenCanvas 미지원 → Worker fallback 필수
- SVG 렌더링은 브라우저마다 미묘한 차이 가능 → 사용자에게 알림
- 외부 폰트 임베딩 SVG는 렌더링 실패 가능 → 경고 표시
- 매우 큰 이미지(>10MB)는 메모리 부족 위험 → 경고 표시

---

**문서 버전**: v1.0  
**작성일**: 2025-01-22  
**최종 수정일**: 2025-01-22  
**작성자**: AI Agent  
**승인자**: (프로젝트 리더)
